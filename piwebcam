#!/bin/bash
set -euo pipefail

CONFIGFS_ROOT="/sys/kernel/config/usb_gadget/pi4"
CFG_INTERVAL_PATH="$CONFIGFS_ROOT/functions/uvc.usb0/streaming/mjpeg/m/720p/dwFrameInterval"
DESIRED_INTERVALS="666666"
USE_SAMPLE_SOURCE="${USE_SAMPLE_SOURCE:-1}"
SAMPLE_FILE="$(pwd)/test-logs/sample_720p.mjpeg"

# Ensure gadget drivers are loaded.
sudo modprobe dwc2 || true
sudo modprobe libcomposite || true

# Ensure gadget exists and has correct intervals. Only rebuild if needed.
if [ ! -e "$CFG_INTERVAL_PATH" ] || [ "$(cat "$CFG_INTERVAL_PATH" 2>/dev/null || true)" != "$DESIRED_INTERVALS" ]; then
    echo "Intervals missing/mismatched; running multi-gadget.sh to configure gadget..."
    sudo ./multi-gadget.sh
fi

# Verify intervals after setup.
if [ ! -e "$CFG_INTERVAL_PATH" ]; then
    echo "ERROR: Interval path missing: $CFG_INTERVAL_PATH"
    exit 2
fi
actual_intervals=$(cat "$CFG_INTERVAL_PATH")
if [ "$actual_intervals" != "$DESIRED_INTERVALS" ]; then
    echo "ERROR: Interval mismatch. Expected '$DESIRED_INTERVALS' got '$actual_intervals'"
    exit 3
fi
echo "✓ Verified intervals: $actual_intervals"

# Ensure UDC is bound (bind only if empty).
UDC_PATH="$CONFIGFS_ROOT/UDC"
udc_current=$(cat "$UDC_PATH" 2>/dev/null || true)
if [ -z "$udc_current" ]; then
    udc_target=$(ls /sys/class/udc | head -n1)
    if [ -z "$udc_target" ]; then
        echo "ERROR: No UDC available to bind"
        exit 4
    fi
    if ! echo "$udc_target" | sudo tee "$UDC_PATH" >/dev/null; then
        echo "ERROR: Failed to bind UDC $udc_target"
        exit 4
    fi
    echo "✓ Bound UDC: $udc_target"
else
    echo "✓ UDC already bound: $udc_current"
fi

if [ "$USE_SAMPLE_SOURCE" -eq 1 ]; then
    echo "Using dummy pattern source (no V4L2, YUYV fill)"
    sudo ./uvc-gadget -f0 -s1 -r0 -d
else
    # Set some camera control options.
    /usr/bin/v4l2-ctl -c auto_exposure=0
    /usr/bin/v4l2-ctl -c auto_exposure_bias=8
    /usr/bin/v4l2-ctl -c contrast=20
    /usr/bin/v4l2-ctl -c video_bitrate=25000000

    # For 720p:
    sudo ./uvc-gadget -f1 -s1 -r0 -u /dev/video1 -v /dev/video0
    # For 1080p:
    #sudo /home/pi/uvc-gadget/uvc-gadget -f1 -s1 -r1 -u /dev/video1 -v /dev/video0
fi
