#!/bin/bash
set -euo pipefail

CONFIGFS_ROOT="/sys/kernel/config/usb_gadget/pi4"
CFG_INTERVAL_PATH="$CONFIGFS_ROOT/functions/uvc.usb0/streaming/mjpeg/m/720p/dwFrameInterval"
DESIRED_INTERVALS="666666"

# Ensure gadget drivers are loaded.
sudo modprobe dwc2 || true
sudo modprobe libcomposite || true

# Fully teardown any existing gadget, then recreate.
sudo ./teardown-gadget.sh "$CONFIGFS_ROOT"
sudo ./multi-gadget.sh

# Verify multi-gadget applied the desired intervals.
if [ ! -e "$CFG_INTERVAL_PATH" ]; then
    echo "ERROR: Interval path missing: $CFG_INTERVAL_PATH"
    exit 2
fi
actual_intervals=$(cat "$CFG_INTERVAL_PATH")
if [ "$actual_intervals" != "$DESIRED_INTERVALS" ]; then
    echo "ERROR: Interval mismatch. Expected '$DESIRED_INTERVALS' got '$actual_intervals'"
    exit 3
fi
echo "âœ“ Verified intervals: $actual_intervals"

# Set some camera control options.
/usr/bin/v4l2-ctl -c auto_exposure=0
/usr/bin/v4l2-ctl -c auto_exposure_bias=8
/usr/bin/v4l2-ctl -c contrast=20
/usr/bin/v4l2-ctl -c video_bitrate=25000000

# For 720p:
sudo ./uvc-gadget -f1 -s1 -r0 -u /dev/video1 -v /dev/video0
# For 1080p:
#sudo /home/pi/uvc-gadget/uvc-gadget -f1 -s1 -r1 -u /dev/video1 -v /dev/video0
